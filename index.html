<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>家人实时位置</title>
    <style>
        html, body, #container { width: 100%; height: 100%; margin: 0; padding: 0; }
        #info { position: absolute; top: 10px; left: 10px; background: white; padding: 5px; border-radius: 5px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); z-index: 10;}
    </style>
    <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=5962ff5fce46b45ac7a7d7888c8926c7"></script>
</head>
<body>
    <div id="container"></div>
    <div id="info">正在连接服务器获取位置...</div>
    <script type="text/javascript">
        // 2. 替换成您自己的高德安全密钥
        window._AMapSecurityConfig = { securityJsCode: '5864aea32c35fd8a7973c3a83b00f83d' };
        
        // 3. 替换成您自己的阿里云“读取”API地址
        const API_READ_URL = "https://gpsapihandler-pwtyadhyqb.cn-beijing.fcapp.run";
        
        const infoDiv = document.getElementById('info');
        let map, marker;
        let isMapInitialized = false;

        function updateLocationOnMap() {
            fetch(API_READ_URL)
                .then(response => response.json())
                .then(data => {
                    // 假设API返回格式为 { "latitude": 31.123, "longitude": 121.543, "timestamp": 1678886400000 }
                    const lat = data.latitude;
                    const lon = data.longitude;
                    const newPosition = new AMap.LngLat(lon, lat);
                    
                    if (!isMapInitialized) {
                        map = new AMap.Map('container', { resizeEnable: true, zoom: 16, center: newPosition });
                        marker = new AMap.Marker({ map: map, position: newPosition });
                        isMapInitialized = true;
                    } else {
                        map.setCenter(newPosition);
                        marker.setPosition(newPosition);
                    }
                    infoDiv.innerText = `最后更新于: ${new Date(data.timestamp).toLocaleTimeString()}`;
                })
                .catch(error => {
                    infoDiv.innerText = "获取位置数据失败";
                    console.error('Error fetching GPS data:', error)
                });
        }
        
        updateLocationOnMap(); // 立即加载一次
        setInterval(updateLocationOnMap, 15000); // 每15秒刷新一次位置
    </script>
</body>
</html>
