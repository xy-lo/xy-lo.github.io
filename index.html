<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>MQTT连接测试</title>
    <script src="https://unpkg.com/paho-mqtt@1.1.0/paho-mqtt.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; }
        #status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>MQTT 发送功能测试</h1>
    <p>此页面用于诊断与MQTT服务器的连接和发送问题。</p>
    <p id="status">正在连接到服务器...</p>
    <button onclick="sendTestMessage()" style="font-size: 1.2em; padding: 10px 20px;">发送测试消息</button>

    <script>
        const statusDiv = document.getElementById('status');
        
        // MQTT 配置 (与您的主程序一致)
        const broker = "broker.emqx.io";
        const port = 8083;
        const clientId = "mqtt-test-client-" + Math.random().toString(16).substr(2, 8);
        const topic = "robot/dog/location_alert";

        const client = new Paho.MQTT.Client(broker, port, "/mqtt", clientId);

        client.onConnectionLost = (responseObject) => {
            if (responseObject.errorCode !== 0) {
                statusDiv.innerText = "连接丢失: " + responseObject.errorMessage;
                statusDiv.style.color = 'red';
            }
        };

        client.connect({
            onSuccess: () => {
                statusDiv.innerText = "服务器已连接";
                statusDiv.style.color = 'green';
                console.log("MQTT Connected!");
            },
            onFailure: (message) => {
                statusDiv.innerText = "连接失败: " + message.errorMessage;
                statusDiv.style.color = 'red';
            }
        });

        function sendTestMessage() {
            if (!client.isConnected()) {
                statusDiv.innerText = "错误：客户端未连接。";
                statusDiv.style.color = 'red';
                return;
            }
            const payload = "test,123,456"; // 发送一条固定的测试消息
            const message = new Paho.MQTT.Message(payload);
            message.destinationName = topic;
            
            try {
                client.send(message);
                statusDiv.innerText = "测试消息已成功发送！";
                statusDiv.style.color = 'blue';
                console.log("Test message sent!");
                // 检查您的ESP8266串口监视器，看是否收到了这条消息
            } catch (e) {
                statusDiv.innerText = "发送时捕获到异常: " + e;
                statusDiv.style.color = 'red';
            }
        }
    </script>
</body>
</html>
